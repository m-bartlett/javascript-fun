<!DOCTYPE HTML>

<head>
    <title>Cogs</title>
    <style type="text/css">
        body {
            background-color: #222;
            margin: 0px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <script>
        var canvas = document.createElement('canvas');
        document.body.appendChild(canvas);
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        var ctx = canvas.getContext('2d');
        const cogs = 5;
        const _omega = Math.random() * 2 * Math.PI;
        const cog = new Cog(null, _omega);
        for (var i = 1; i < cogs; i++) {
            cog.children.push(new Cog(cog, _omega + i / cogs * Math.PI * 2))
        }
        draw();

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            cog.render();
            window.requestAnimationFrame(draw);

        }

        function Cog(parent = null, omega = Math.random() * 2 * Math.PI) {
            this.teeth = Math.ceil(Math.random() * 50) + 2;
            // this.teeth = Math.ceil(Math.random() * (parent ? parent.teeth : 100)) + (!parent ? 5 : 0);
            if (parent) var ratio = parent.teeth / this.teeth;
            // this.r = parent ? parent.r / ratio : Math.min(canvas.width, canvas.height) / 4 * (Math.random() * 0.9 + 0.1);
            this.r = parent ? parent.r / ratio : 350;
            this.toothSize = parent ? parent.toothSize : this.r / 12 * Math.random() + this.r / 24;
            // this.toothSize = this.r / 12 * Math.random() + this.r / 24;
            this.x = parent ? parent.x + (parent.r + this.r) * Math.cos(omega) : canvas.width / 2;
            this.y = parent ? parent.y + (parent.r + this.r) * Math.sin(omega) : canvas.height / 2;
            this.toothShape = Math.random() / (parent && this.r > parent.r ? 2 : 1) / (this.teeth < 7 ? 2 : 1)
            this.r2 = parent ? Math.abs(this.r - this.toothSize) * (Math.random() * 0.75 + 0.25) : 300;
            this.rotation = parent ? Math.PI + Math.PI / this.teeth - ratio * parent.rotation + omega + ratio * omega : 0;
            this.angularVel = parent ? parent.angularVel * -ratio : Math.PI / 270 * Math.random() + Math.PI / 720;
            this.children = [];

            if (this.x > 0 && this.x < canvas.width && this.y > 0 && this.y < canvas.height) {
                // this.children.push(new Cog(this, omega * (Math.random() * Math.PI / 4) - Math.PI / 8));
                this.children.push(new Cog(this, omega));
            }

            this.render = function(alpha = 0.9) {
                ctx.save();
                ctx.fillStyle = "white"
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.beginPath();
                ctx.moveTo(this.r + this.toothSize, 0);
                const resolution = this.teeth * 8
                for (var i = 1; i <= resolution; i++) {
                    var a = i / resolution * 2 * Math.PI;
                    var phase = 1 / (2 * Math.PI) * this.teeth * a;
                    phase -= Math.floor(phase);

                    var toothHeight = 4.0 * Math.abs(phase - 0.5) - 1.0;
                    var radius = this.r + this.toothSize * Math.min(Math.max(toothHeight / this.toothShape, -1), 1);
                    ctx.lineTo(radius * Math.cos(a), radius * Math.sin(a))
                }
                ctx.closePath();

                ctx.save();
                ctx.globalAlpha = alpha
                ctx.fill();
                ctx.restore()

                ctx.save();
                ctx.globalCompositeOperation = 'destination-out'
                ctx.beginPath();
                ctx.arc(0, 0, this.r2, 0, Math.PI * 2)
                ctx.fill();
                ctx.restore();

                ctx.restore();

                this.rotation += this.angularVel;
                if (alpha > 0.1)
                    for (c of this.children) c.render(alpha * alpha);
            }
        }
    </script>
</body>

</html>