<!DOCTYPE HTML>

<head>
    <title>Nova</title>
     <style type="text/css">
        body {
            background-color: #222;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <script>
        const _G = 6.674*Math.pow(10,-2);
        var canvas = document.createElement('canvas');
        document.body.appendChild(canvas);
        var ctx = canvas.getContext('2d');
        window.addEventListener('resize', resizeCanvas, false);
        var c = canvas.width > canvas.height ? {max: canvas.width, min: canvas.height} : {max: canvas.height, min: canvas.width}
        function resizeCanvas() { 
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight; 
            c = canvas.width > canvas.height ? {max: canvas.width, min: canvas.height} : {max: canvas.height, min: canvas.width}
        }
        resizeCanvas();

        var g = new galaxy(500);
        g.render(ctx);

        function star(id) {
            this.r  = Math.random() * c.min / 500
            cmax = c.max*Math.random();
            var theta = Math.random()*2*Math.PI;
            this.x  = cmax/2*Math.cos(theta);     //x position
            this.y  = cmax/2*Math.sin(theta);     //y position
            this.dx = Math.cos(theta)*(2+Math.abs(Math.log10(_G)));     //x velocity
            // this.dy = -Math.sin(theta)*(2+Math.abs(Math.log10(_G)));     //y velocity
            this.dy = 0     //y velocity
            this.color = 'hsl(' + Math.random()*360 + ',100%,50%)';

            this.render = function(c) { 
                c.beginPath();
                c.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                // c.arc(this.x, this.y, this.r*Math.pow((this.z+canvas.width/2)/canvas.width,3), 0, Math.PI * 2);
                c.closePath()
                c.fillStyle = this.color;
                c.fill();
            }

            this.gravitate = function(b) {
                var dist = Math.sqrt(Math.pow(this.x-b.x,2) + Math.pow(this.y-b.y,2));
                var fx = _G*this.r*b.r/Math.pow(dist,2)*(b.x-this.x), fy = _G*this.r*b.r/Math.pow(dist,2)*(b.y-this.y);
                this.dx += fx / this.r; this.dy += fy / this.r;
                b.dx -= fx / b.r; b.dy -= fy / b.r;
                var big = this.r > b.r  ? {r: this.r, s: this, n: b, ret: 1} : {r: b.r, s: b, n: this, ret: -1};
                if (dist < big.r) { big.s.absorb(big.n); return big.ret; }
                else return 0;
            }

            this.absorb = function(b) {
                this.r += Math.sqrt(b.r/2)
                this.dx = (this.dx*this.r + b.dx*b.r) / (this.r + b.r)
                this.dy = (this.dy*this.r + b.dy*b.r) / (this.r + b.r)
            }
        }

        function galaxy(mass) {
            this.stars = [new star()]     
            if (mass) while (mass > 0) { this.stars.push(new star(this.stars.length)); mass -= this.stars[this.stars.length-1].r; }
            this.stars[0].x = this.stars[0].y = this.stars[0].z = this.stars[0].dx = this.stars[0].dy = this.stars[0].dz = 0;
            this.stars[0].r = Math.min(canvas.height, canvas.width) / 120
            
            this.gravitate = function() {
                for (var i=0; i<this.stars.length; i++) {
                    for (var j=i+1; j<this.stars.length; j++) {
                        var ret = this.stars[i].gravitate(this.stars[j]);
                        if (ret > 0) { this.stars.splice(j,1); j--; continue; }
                        else if (ret < 0) { this.stars.splice(i,1); i--; break; }
                    }
                }
                for (var i=this.stars.length-1; i > 1; i--) {
                    this.stars[i].x += this.stars[i].dx;
                    this.stars[i].y += this.stars[i].dy;
                    if (this.stars[i].x < -c.max || this.stars[i].x > c.max || this.stars[i].y < -c.max || this.stars[i].y > c.max) {
                        this.stars.splice(i,1);
                    }
                }
            }
            
            this.render = function(c) { 
                c.save();
                // c.clearRect(0,0,canvas.width,canvas.height);
                c.save();
                c.fillStyle= "rgba(0,0,0,0.05)";
                c.fillRect(0,0,canvas.width, canvas.height);
                c.restore();
                c.translate(canvas.width/2,canvas.height/2);
                this.gravitate();
                for (var s of this.stars) s.render(c);      
                c.restore();
                var self = this;
                requestAnimationFrame(function() { self.render(c)});
            }
        }
    </script>
    </body>

    </html>